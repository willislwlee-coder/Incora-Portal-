<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Incora Customer Parts Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --primary: #003b5c;
      --primary-light: #e6f0f5;
      --accent: #00a3e0;
      --bg: #f5f7fa;
      --danger: #c0392b;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
      background: var(--bg);
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      color: #333;
    }
    .app-wrapper {
      width: 100%;
      max-width: 960px;
      padding: 24px;
    }
    .card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.08);
      padding: 24px 28px 28px;
      position: relative;
      overflow: hidden;
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      gap: 16px;
      flex-wrap: wrap;
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .brand-logo-img {
      height: 32px;
      object-fit: contain;
    }
    .brand-text-main {
      font-weight: 700;
      font-size: 18px;
      color: var(--primary);
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }
    .brand-text-sub {
      font-size: 11px;
      text-transform: uppercase;
      opacity: 0.7;
      letter-spacing: 0.16em;
    }
    h1 {
      font-size: 18px;
      margin: 0 0 6px;
      color: var(--primary);
    }
    .subtitle {
      font-size: 13px;
      margin-bottom: 18px;
      color: #555;
    }
    .search-section {
      background: #f9fbfd;
      border-radius: 10px;
      padding: 14px 16px 16px;
      border: 1px solid #e0e6ee;
      margin-bottom: 16px;
    }
    .search-section label {
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.09em;
      color: #666;
      display: block;
      margin-bottom: 4px;
    }
    .search-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: flex-start;
    }
    textarea {
      flex: 1;
      min-height: 70px;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #cfd6e0;
      resize: vertical;
      font-family: inherit;
      font-size: 13px;
    }
    textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(0,163,224,0.32);
    }
    .hint {
      font-size: 11px;
      color: #777;
      margin-top: 4px;
    }
    button {
      cursor: pointer;
      border: none;
      border-radius: 999px;
      padding: 8px 18px;
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: var(--primary);
      color: #fff;
      white-space: nowrap;
    }
    button.secondary {
      background: transparent;
      color: var(--primary);
      border: 1px solid #d0d7e4;
    }
    button:disabled {
      opacity: 0.55;
      cursor: default;
    }
    .button-row {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .status-bar {
      font-size: 11px;
      color: #666;
      margin-top: 6px;
      display: flex;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }
    .status-bar span {
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #9e9e9e;
    }
    .status-dot.ok {
      background: #27ae60;
    }
    .status-dot.error {
      background: var(--danger);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 14px;
      font-size: 13px;
    }
    th, td {
      padding: 8px 10px;
      text-align: left;
      border-bottom: 1px solid #ecf0f4;
    }
    th {
      background: #f4f7fb;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #5b6475;
    }
    tr:nth-child(even) td {
      background: #fafbfd;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 11px;
      background: #ecf5ff;
      color: #2c4f7c;
    }
    .no-results {
      font-size: 13px;
      color: #777;
      text-align: center;
      padding: 12px 0 4px;
    }
    .footer-note {
      margin-top: 10px;
      font-size: 10px;
      color: #8c94a5;
      text-align: right;
    }
    .top-bar-meta {
      font-size: 11px;
      color: #666;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .top-bar-meta span {
      max-width: 220px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .login-overlay {
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at top, rgba(0,163,224,0.18), transparent 55%), rgba(4,14,30,0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }
    .login-card {
      background: #ffffff;
      padding: 22px 24px 20px;
      border-radius: 12px;
      width: 100%;
      max-width: 380px;
      box-shadow: 0 18px 40px rgba(0,0,0,0.45);
      text-align: left;
    }
    .login-title {
      font-size: 16px;
      font-weight: 600;
      margin: 0 0 4px;
      color: var(--primary);
    }
    .login-sub {
      font-size: 12px;
      color: #666;
      margin-bottom: 14px;
    }
    .login-label {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #777;
      margin-bottom: 4px;
      display: block;
    }
    .login-input {
      width: 100%;
      padding: 7px 9px;
      border-radius: 8px;
      border: 1px solid #ccd3e1;
      font-size: 13px;
      margin-bottom: 8px;
    }
    .login-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(0,163,224,0.32);
    }
    .login-error {
      font-size: 11px;
      color: var(--danger);
      min-height: 14px;
      margin-bottom: 4px;
    }
    .login-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 4px;
      gap: 8px;
    }
    .login-meta {
      font-size: 10px;
      color: #999;
    }
    @media (max-width: 640px) {
      .card {
        padding: 18px 16px 20px;
      }
      .card-header {
        flex-direction: column;
        align-items: flex-start;
      }
      .search-row {
        flex-direction: column;
      }
      .button-row {
        flex-direction: row;
        justify-content: flex-start;
      }
    }
  </style>
</head>
<body>
  <!-- LOGIN OVERLAY -->
  <div class="login-overlay" id="loginOverlay">
    <div class="login-card">
      <div class="brand" style="margin-bottom:10px;">
        <img src="incora-logo.png" alt="Incora" class="brand-logo-img" />
        <div>
          <div class="brand-text-main">INCORA</div>
          <div class="brand-text-sub">Customer access</div>
        </div>
      </div>
      <h2 class="login-title">Secure Parts Portal</h2>
      <p class="login-sub">
        Authorised users only. Enter your assigned username and password to continue.
      </p>

      <label class="login-label" for="usernameInput">Username</label>
      <input type="text" id="usernameInput" class="login-input" placeholder="e.g. user001" />

      <label class="login-label" for="passwordInput">Password</label>
      <input type="password" id="passwordInput" class="login-input" placeholder="Enter password" />

      <div class="login-error" id="loginError"></div>
      <div class="login-footer">
        <button id="loginBtn">Sign in</button>
        <div class="login-meta">
          Each customer will be assigned a unique account.<br/>
          Contact your Incora representative if you need access.
        </div>
      </div>
    </div>
  </div>

  <!-- MAIN APP -->
  <div class="app-wrapper" id="appRoot" style="display:none;">
    <div class="card">
      <div class="card-header">
        <div class="brand">
          <img src="incora-logo.png" alt="Incora" class="brand-logo-img" />
          <div>
            <div class="brand-text-main">INCORA</div>
            <div class="brand-text-sub">Customer parts availability</div>
          </div>
        </div>
        <div class="top-bar-meta">
          <span id="userLabel"></span>
          <button type="button" class="secondary" id="logoutBtn">Logout</button>
        </div>
      </div>

      <h1>Parts Availability &amp; Pricing Search</h1>
      <div class="subtitle">
        Enter one or more part numbers to check current sell price and on-hand quantity.
      </div>

      <div class="search-section">
        <label for="partInput">Part numbers</label>
        <div class="search-row">
          <textarea id="partInput" placeholder="e.g. ABC123, DEF456&#10;You can paste from Excel or enter one per line."></textarea>
          <div class="button-row">
            <button id="searchBtn"><span>Search</span></button>
            <button type="button" class="secondary" id="clearBtn">Clear</button>
          </div>
        </div>
        <div class="hint">
          • Separate part numbers by commas, spaces, or new lines. <br/>
          • Search is not case-sensitive and matches exact part numbers.
        </div>
        <div class="status-bar">
          <span>
            <span id="statusDot" class="status-dot"></span>
            <span id="statusText">Loading data...</span>
          </span>
          <span id="summaryText"></span>
        </div>
      </div>

      <table id="resultsTable" style="display:none;">
        <thead>
          <tr>
            <th>Part Number</th>
            <th>Quantity Available</th>
            <th>Sell Price</th>
            <th>Certificate Available</th>
          </tr>
        </thead>
        <tbody id="resultsBody"></tbody>
      </table>
      <div class="no-results" id="noResults" style="display:none;">
        No results yet. Enter part numbers above and click <strong>Search</strong>.
      </div>

      <div class="footer-note">
        Data shown is indicative and subject to confirmation. &copy; Incora.
      </div>
    </div>
  </div>

  <script>
  const AUTH_ENDPOINT = "https://script.google.com/macros/s/AKfycbyVfU0GpnO-ZOOvX4T0rvE2meP8q1PpuJSktGNvnI53J9hYNyfRplraf4cNd3MRXHxJ/exec";

  const validUsers = {
    "user001": "Xp!9Qa7LzV",
    "Vivian": "Incoratest"
  };
  const LOG_ENDPOINT =
    "https://script.google.com/macros/s/AKfycbwfjf0KZ5WB95XLdEd9Wl2RGjf_kiVMTNli23kBOYfNv1pNacnm_jBHE8DuarAvmUklkQ/exec";

  let currentUser = null;

  const loginOverlay = document.getElementById("loginOverlay");
  const appRoot = document.getElementById("appRoot");
  const loginBtn = document.getElementById("loginBtn");
  const usernameInput = document.getElementById("usernameInput");
  const passwordInput = document.getElementById("passwordInput");
  const loginError = document.getElementById("loginError");
  const userLabel = document.getElementById("userLabel");
  const logoutBtn = document.getElementById("logoutBtn");

  function showApp(username) {
    currentUser = username;
    userLabel.textContent = "Logged in as: " + username;
    loginOverlay.style.display = "none";
    appRoot.style.display = "block";
  }

  function showLogin() {
    appRoot.style.display = "none";
    loginOverlay.style.display = "flex";
    usernameInput.value = "";
    passwordInput.value = "";
    loginError.textContent = "";
  }

  
  function attemptLogin() {
    const u = usernameInput.value.trim();
    const p = passwordInput.value.trim();

    if (!u || !p) {
      loginError.textContent = "Username and password are required.";
      return;
    }

    const expected = validUsers[u];
    if (expected && expected === p) {
      loginError.textContent = "";
      try { localStorage.setItem("incora_current_user", u); } catch (e) {}
      showApp(u);
    } else {
      loginError.textContent = "Invalid username or password.";
    }
  }

  loginBtn.addEventListener("click", attemptLogin);
  passwordInput.addEventListener("keypress", function (e) {
    if (e.key === "Enter") attemptLogin();
  });

  logoutBtn.addEventListener("click", function () {
    try { localStorage.removeItem("incora_current_user"); } catch (e) {}
    showLogin();
  });

  (function initLogin() {
    let storedUser = null;
    try {
      storedUser = localStorage.getItem("incora_current_user");
    } catch (e) {}
    if (storedUser) {
      showApp(storedUser);
    } else {
      showLogin();
    }
  })();

  let partsData = [];

  const statusDot = document.getElementById("statusDot");
  const statusText = document.getElementById("statusText");
  const summaryText = document.getElementById("summaryText");
  const resultsTable = document.getElementById("resultsTable");
  const resultsBody = document.getElementById("resultsBody");
  const noResults = document.getElementById("noResults");
  const partInput = document.getElementById("partInput");
  const searchBtn = document.getElementById("searchBtn");
  const clearBtn = document.getElementById("clearBtn");

  function logSearchToBackend(requested, index, foundCount) {
    try {
      if (!LOG_ENDPOINT) return;
      const results = {};
      requested.forEach(code => {
        const key = code.toUpperCase();
        const row = index[key];
        results[code] = {
          quantity: row && row.quantity_available ? row.quantity_available : "",
          price: row && row.sell_price ? row.sell_price : ""
        };
      });
      const payload = {
        username: currentUser || "",
        parts: requested,
        results: results
      };
      fetch(LOG_ENDPOINT, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      }).catch(e => {});
    } catch (e) {}
  }

  async function loadData() {
    try {
      const response = await fetch("parts_data.csv?_=" + Date.now());
      if (!response.ok) {
        statusDot.className = "status-dot error";
        statusText.textContent = "Error loading data file (parts_data.csv).";
        return;
      }
      const csvText = await response.text();
      partsData = parseCSV(csvText);
      statusDot.className = "status-dot ok";
      statusText.textContent = "Data loaded. Last refreshed now.";
      summaryText.textContent = partsData.length + " part numbers available.";
    } catch (err) {
      statusDot.className = "status-dot error";
      statusText.textContent = "Error loading data: " + err;
    }
  }

  function parseCSV(text) {
    const lines = text.trim().split(/\r?\n/);
    if (lines.length < 2) return [];
    const headers = lines[0].split(",");
    const data = [];
    for (let i = 1; i < lines.length; i++) {
      if (!lines[i].trim()) continue;
      const cols = splitCSVLine(lines[i]);
      const row = {};
      headers.forEach((h, idx) => {
        row[h.trim()] = (cols[idx] || "").trim();
      });
      data.push(row);
    }
    return data;
  }

  function splitCSVLine(line) {
    const result = [];
    let current = "";
    let inQuotes = false;
    for (let i = 0; i < line.length; i++) {
      const char = line[i];
      if (char === '"') {
        inQuotes = !inQuotes;
      } else if (char === "," && !inQuotes) {
        result.push(current);
        current = "";
      } else {
        current += char;
      }
    }
    result.push(current);
    return result;
  }

  function normalisePartList(raw) {
    const tokens = raw
      .split(/\r?\n|,|\s/)
      .map(t => t.trim())
      .filter(Boolean);
    return [...new Set(tokens)];
  }

  function searchParts() {
    const raw = partInput.value.trim();
    resultsBody.innerHTML = "";
    resultsTable.style.display = "none";
    noResults.style.display = "none";
    summaryText.textContent = "";

    if (!raw) {
      noResults.style.display = "block";
      noResults.textContent = "Please enter at least one part number above.";
      return;
    }

    const requested = normalisePartList(raw);
    if (requested.length === 0) {
      noResults.style.display = "block";
      noResults.textContent = "Please enter valid part numbers.";
      return;
    }

    const index = {};
    partsData.forEach(row => {
      if (row.part_number) index[row.part_number.toUpperCase()] = row;
    });

    let foundCount = 0;

    requested.forEach(code => {
      const key = code.toUpperCase();
      const row = index[key];
      const tr = document.createElement("tr");

      const tdPart = document.createElement("td");
      const tdQty = document.createElement("td");
      const tdPrice = document.createElement("td");
      const tdCert = document.createElement("td");

      tdPart.textContent = code;

      if (row) {
        foundCount++;
        tdQty.textContent = row.quantity_available || "";
        tdPrice.textContent = row.sell_price || "";
        const cert = row.cert_available || row["cert available"] || "";
        tdCert.textContent = cert;
      } else {
        tdQty.innerHTML = '<span class="badge">Not found</span>';
        tdPrice.textContent = "-";
        tdCert.textContent = "-";
      }

      tr.appendChild(tdPart);
      tr.appendChild(tdQty);
      tr.appendChild(tdPrice);
      tr.appendChild(tdCert);
      resultsBody.appendChild(tr);
    });

    resultsTable.style.display = "";
    summaryText.textContent =
      foundCount + " of " + requested.length + " part numbers found.";

    if (foundCount === 0) {
      noResults.style.display = "block";
      noResults.textContent =
        "No matching parts found in current dataset.";
    } else {
      noResults.style.display = "none";
    }

    logSearchToBackend(requested, index, foundCount);
  }

  function clearSearch() {
    partInput.value = "";
    resultsBody.innerHTML = "";
    resultsTable.style.display = "none";
    noResults.style.display = "block";
    noResults.textContent =
      "No results yet. Enter part numbers above and click Search.";
    summaryText.textContent = "";
  }

  searchBtn.addEventListener("click", searchParts);
  clearBtn.addEventListener("click", clearSearch);

  partInput.addEventListener("keypress", function (e) {
    if (e.key === "Enter") {
      e.preventDefault();
      searchParts();
    }
  });

  loadData();
</script>

</body>
</html>
